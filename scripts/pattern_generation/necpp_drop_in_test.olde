#!/bin/bash
# Test necpp as drop-in replacement for nec2c

# Check if necpp is available
if ! command -v necpp >/dev/null 2>&1; then
    echo "necpp not found. Install with:"
    echo "  sudo apt install necpp          # Ubuntu/Debian"
    echo "  sudo dnf install necpp          # Fedora"
    echo "  sudo pacman -S necpp            # Arch"
    exit 1
fi

echo "Testing necpp compatibility..."

# Test 1: Check version and help
echo "=== necpp version ==="
necpp --version 2>/dev/null || necpp -h

# Test 2: Create a simple test NEC file
cat > test_necpp.nec << 'EOF'
CE Simple dipole test
GW 1 7 0 0 0 0 0 0.5 0.001
GE 0
FR 0 1 0 0 100 0
EX 0 1 4 0 1 0
RP 0 37 73 1000 0 0 5 5
EN
EOF

echo ""
echo "=== Testing with regular filename ==="
if necpp -i test_necpp.nec -o test_necpp.out; then
    echo "✅ necpp works with regular filenames"
    ls -la test_necpp.out
else
    echo "❌ necpp failed with regular filename"
fi

# Test 3: Test with long filename
mv test_necpp.nec test_with_a_very_long_filename_that_would_break_nec2c_but_should_work_with_necpp.nec

echo ""
echo "=== Testing with long filename ==="
if necpp -i test_with_a_very_long_filename_that_would_break_nec2c_but_should_work_with_necpp.nec -o long_filename_output.out; then
    echo "✅ necpp works with long filenames"
    ls -la long_filename_output.out
else
    echo "❌ necpp failed with long filename"
fi

# Test 4: Compare output format with nec2c if available
if command -v nec2c >/dev/null 2>&1; then
    echo ""
    echo "=== Comparing output with nec2c ==="
    # Use short filename for nec2c
    mv test_with_a_very_long_filename_that_would_break_nec2c_but_should_work_with_necpp.nec short.nec
    
    if nec2c -i short.nec -o nec2c.out 2>/dev/null; then
        echo "Output line count comparison:"
        echo "  nec2c:  $(wc -l < nec2c.out) lines"
        echo "  necpp:  $(wc -l < long_filename_output.out) lines"
        
        echo ""
        echo "First 10 lines of nec2c output:"
        head -n 10 nec2c.out
        
        echo ""
        echo "First 10 lines of necpp output:"
        head -n 10 long_filename_output.out
    fi
fi

# Cleanup
rm -f *.nec *.out

echo ""
echo "=== Conclusion ==="
echo "If both tests passed, you can replace 'nec2c' with 'necpp' in your script"